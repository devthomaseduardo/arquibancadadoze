// Torcida Urbana - Schema do banco de dados
// Backend dropshipping camisas de futebol

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== CATÁLOGO ==========

model Category {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  costMin     Float     // custo fornecedor mínimo (R$)
  costMax     Float     // custo fornecedor máximo (R$)
  imageUrl    String?
  sortOrder   Int       @default(0)
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
}

model Product {
  id          String    @id @default(cuid())
  categoryId  String
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  supplierId  String?   // Fornecedor 1, Fornecedor 2 — só visível no admin; cliente não vê
  supplier    Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  name        String
  slug        String    @unique
  description String?
  costMin     Float     // custo deste fornecedor
  costMax     Float
  priceMin    Float     // preço revenda mínimo (o que o cliente vê)
  priceMax    Float     // preço revenda máximo
  imageUrl    String?
  sizes       String   // JSON array: ["P","M","G","GG"] ou ["Único"]
  minimumMargin Float    @default(20.0) // % Margem mínima padrão
  active      Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  orderItems  OrderItem[]
  variants    ProductVariant[]
}

model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  size      String
  quantity  Int      @default(0)
  sku       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, size])
}

// ========== USUÁRIOS (clientes - login para acompanhar pedido) ==========

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String
  role         String    @default("CUSTOMER") // CUSTOMER, ADMIN, etc.
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  orders       Order[]
}

// ========== PEDIDOS ==========

model Order {
  id                 String    @id @default(cuid())
  orderNumber        String    @unique // número exibido (ex: #1001)
  userId             String?   // se o cliente estava logado
  user               User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  // Cliente
  customerName       String
  customerEmail      String
  customerPhone      String?
  customerCpf        String?   // opcional
  // Endereço
  addressStreet      String
  addressNumber      String
  addressComplement  String?
  addressNeighborhood String?
  addressCity       String
  addressState      String
  addressZip         String
  // Valores
  subtotal           Float     // soma dos produtos
  shippingCost       Float     // frete cobrado ao cliente
  shippingCostPaid   Float?    // frete pago ao fornecedor/correio
  totalAmount        Float     // total da venda
  totalCost          Float?    // custo total (produtos + frete pago)
  estimatedProfit    Float?    // totalAmount - totalCost
  // Pagamento e status
  paymentMethod      String    // cartao, boleto, pix
  paymentStatus      String    // pendente, aprovado, estornado
  orderStatus        String    // aguardando, em_separacao, enviado, entregue, trocado_devolvido
  // Envio
  trackingCode       String?
  trackingUrl        String?
  shippedAt          DateTime?
  // Metadados
  notes              String?   // notas internas
  source             String?   // site, shopee, ml, amazon, nuvemshop, manual (canal de venda)
  externalId         String?   // ID do pedido na Nuvemshop
  mercadopagoPaymentId String? // ID do pagamento no MP
  mercadopagoPreferenceId String? // ID da preferência (PIX/boleto)

  
  // Financeiro
  platformFee       Float?    @default(0) // Taxa da plataforma/gateway (R$)
  commissionValue   Float?    @default(0) // Valor pago ao influenciador (R$)
  netProfit         Float?    // Lucro Líquido Real (R$)
  netMarginPercent  Float?    // Margem Líquida %
  
  influencerId      String?
  influencer        Influencer? @relation(fields: [influencerId], references: [id])
  appliedCoupon     String?

  createdAt          DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  items              OrderItem[]
  communications     OrderCommunication[]
  returns            ReturnExchange[]
  events             OrderEvent[]
}

model OrderItem {
  id             String   @id @default(cuid())
  orderId        String
  order          Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId      String?
  product        Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  productName    String   // nome no momento da compra
  variation      String?  // tamanho, cor (ex: "M", "Preta")
  sku            String?  // SKU do fornecedor
  quantity       Int      @default(1)
  unitPrice      Float    // preço de venda unitário
  unitCost       Float?   // custo unitário fornecedor
  lineTotal      Float    // quantity * unitPrice
  lineCost       Float?   // quantity * unitCost
  personalization String? // número/nome na camisa
  itemNotes      String?  // observações do item
}

model OrderCommunication {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  type      String   // whatsapp, email, interno
  content   String
  createdAt DateTime @default(now())
}

// Audit log: mudanças de status e campos do pedido
model OrderEvent {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  field     String   // orderStatus, paymentStatus, trackingCode, etc.
  oldValue  String?
  newValue  String?
  userId    String?  // quem alterou (admin/sistema)
  createdAt DateTime @default(now())
}

// ========== TROCAS E DEVOLUÇÕES (RMA) ==========

model ReturnExchange {
  id           String    @id @default(cuid())
  orderId      String
  order        Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  reason       String    // defeito_fabricacao, tamanho_errado, outro
  status       String    // solicitado, aprovado, aguardando_envio_cliente, recebido, resolvido, negado
  description  String?
  deliveredAt  DateTime? // data entrega (para validar prazo 7 dias)
  evidenceUrl  String?   // fotos/evidências
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

// ========== CONTEÚDO / CONFIGURAÇÃO ==========

model ShippingPolicy {
  id          String   @id @default(cuid())
  region      String   @unique // Sudeste, Sul, Nordeste, Norte, Centro-Oeste
  price       Float    // valor fixo R$
  description String?
}

model Faq {
  id       String @id @default(cuid())
  question String
  answer   String
  sortOrder Int   @default(0)
}

model SiteConfig {
  id    String @id @default(cuid())
  key   String @unique
  value String // JSON para valores complexos
}

// Regras de precificação por canal (site, shopee, ml, amazon)
model PricingConfig {
  id                 String   @id @default(cuid())
  channel            String   @unique // site, shopee, ml, amazon
  taxaCanalPercent   Float    @default(0)   // ex: 0.18
  taxaCanalFixa      Float    @default(0)   // R$
  lucroMin           Float    @default(30)  // R$
  lucroAlvo          Float    @default(50)  // R$
  precoPsicologico   Boolean  @default(true) // termina em 9
  metaVendasAlta     Int      @default(10)  // vendas em 7d para subir 5%
  metaVendasBaixa    Int      @default(2)   // vendas em 7d para baixar 3%
  ajusteUrgente     Float    @default(20)  // +R$ quando prejuízo
  createdAt          DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// Fornecedores (custo/preço por fornecedor; admin vê, cliente não)
model Supplier {
  id           String    @id @default(cuid())
  name         String    // ex: Fornecedor 1, Fornecedor 2
  whatsapp     String?
  leadTimeDays Int?      // prazo típico em dias
  active       Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  products     Product[]
}

// ========== FINANCEIRO & CAMPANHAS ==========

model Campaign {
  id          String   @id @default(cuid())
  name        String
  targetCategorySlug String? // Se null, aplica a tudo ou define lógica code-level
  active      Boolean  @default(true)
  startDate   DateTime
  endDate     DateTime
  minMarginOverride Float? // % de margem mínima forçada nessa campanha
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Influencer {
  id             String   @id @default(cuid())
  name           String
  couponCode     String   @unique
  commissionRate Float    @default(5.0) // % padrão
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  orders         Order[]
}

// Alterações em Product (adicionar margem default)
// Alterações em Order (adicionar campos financeiros)
